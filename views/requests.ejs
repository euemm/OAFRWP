<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= typeof pageTitle !== 'undefined' ? pageTitle : 'OA Requests' %></title>
  <link rel="icon" type="image/png" href="/public/brandeis.png">
  <link rel="shortcut icon" type="image/png" href="/public/brandeis.png">
  <style>
    :root { --radius: 16px; --gap: 12px; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: #fff; color: #111; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; line-height: 1.45; }

    /* --- HERO HEADER --- */
    .hero { height: 180px; background: rgb(18,51,116) center/cover no-repeat; position: relative; display: flex; align-items: center; justify-content: center; }
    /* .hero { height: 180px; background: url('<%= typeof headerBgUrl !== 'undefined' ? headerBgUrl : '/public/header.jpg' %>') center/cover no-repeat; position: relative; display: flex; align-items: center; justify-content: center; } */
    .hero::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,.28); }
    .hero-inner { position: relative; z-index: 1; width: min(1200px, 100%); display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 0 20px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,.45); }
    .hero h1 { margin: 0; font-size: 1.5rem; }
    .budget-box { text-align: right; }
    .budget-label { display:block; font-size: .9rem; opacity:.9; }
    .budget-amount { font-size: 1.9rem; font-weight: 800; letter-spacing:.3px; }

    /* --- LAYOUT --- */
    .wrapper { min-height: calc(100vh - 180px); display: flex; flex-direction: column; padding: 24px; }
    .fixed-sections { flex-shrink: 0; }
    .scrollable-section { flex: 1; overflow: hidden; }
    .card { background: #fff; border: 1px solid #eee; border-radius: var(--radius); box-shadow: 0 1px 6px rgba(0,0,0,.06); padding: 20px; }

    header.section-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    h2 { margin: 0; font-size: 1.2rem; }
    .actions { display:flex; align-items:center; gap:8px; }
    button, .btn { display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; border:1px solid #ddd; background:#111; color:#fff; border-radius:999px; font-weight:700; cursor:pointer; }
    button.ghost { background:#fff; color:#111; }

    .status { font-weight:700; padding:4px 8px; border-radius:999px; border:1px solid #eee; }
    .table-wrap { 
      border:1px solid #eee; 
      border-radius:12px; 
      transform: rotateX(180deg);
    }
    
    .table-wrap table {
      transform: rotateX(180deg);
    }
    table { width:100%; border-collapse:separate; border-spacing:0; min-width:1400px; }
    thead th { position:sticky; top:0; background:#fafafa; border-bottom:1px solid #eee; text-align:left; padding:12px; font-size:.9rem; min-width: 120px; }
    tbody td { border-bottom:1px solid #f1f1f1; padding:12px; vertical-align:top; font-size:.95rem; min-width: 120px; }
    
    /* Text wrapping for long content */
    .text-wrap { 
      word-wrap: break-word; 
      word-break: break-word; 
      max-width: 200px; 
      white-space: normal;
    }
    .text-truncate {
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Column toggle controls */
    .column-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .column-toggle {
      padding: 4px 8px;
      font-size: 0.8rem;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .column-toggle:hover {
      background: #e9ecef;
    }
    .column-toggle.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    .columns-info {
      font-size: 0.85rem;
      color: #6c757d;
      margin-left: auto;
    }
    tbody tr:hover { background:#fcfcfc; }
    .nowrap { white-space:nowrap; }
    .small { font-size:.85rem; color:#444; }
    .actions-cell { min-width: 0px; }
    
    /* Specific column widths for better readability */
    .col-timestamp { min-width: 110px; }
    .col-email { min-width: 110px; }
    .col-title { min-width: 250px; }
    .col-amount { min-width: 140px; }
    .col-author { min-width: 180px; }
    .col-orcid { min-width: 150px; }
    .col-journal { min-width: 200px; }
    .col-issn { min-width: 120px; }
    .col-publisher { min-width: 160px; }
    .col-article-status { min-width: 120px; }
    .col-pub-type { min-width: 140px; }
    .col-collabs { min-width: 200px; }
    .col-collab-orcid { min-width: 150px; }
    .col-doi { min-width: 150px; }
    .col-comment { min-width: 200px; }
    .col-status { min-width: 120px; }

    /* status row highlighting */
    .paid-bg { background: #e9f7ef !important; } /* light green */
    .denied-bg { background: #fdeaea !important; } /* light red */
    .cancelled-bg { background: #fff3cd !important; } /* light yellow/orange */
    
    /* hover effects for status rows */
    .paid-bg:hover { background: #d4edda !important; } /* darker green on hover */
    .denied-bg:hover { background: #f8d7da !important; } /* darker red on hover */
    .cancelled-bg:hover { background: #ffeaa7 !important; } /* darker yellow on hover */

    /* dropdown (select) style */
    .action-select { padding: 7px 10px; border-radius: 999px; border: 1px solid #ccc; background: #fff; font-weight: 600; }
    .action-select:disabled { opacity: .6; }
    .inline-controls { display:flex; gap:8px; align-items:center; }
    
    /* Edit functionality styles */
    .edit-btn { 
      padding: 4px 8px; 
      font-size: 0.8rem; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      margin-left: 8px;
    }
    .edit-btn:hover { background: #0056b3; }
    .edit-btn:disabled { background: #6c757d; cursor: not-allowed; }
    
    /* Modal overlay */
    .edit-modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000;
    }
    .edit-modal.show { display: flex; }
    .edit-modal-content { 
      background: white; 
      padding: 24px; 
      border-radius: 8px; 
      max-width: 500px; 
      width: 90%; 
      max-height: 80vh; 
      overflow-y: auto;
    }
    .edit-modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 16px; 
      padding-bottom: 12px; 
      border-bottom: 1px solid #eee;
    }
    .edit-modal-title { 
      font-size: 1.2rem; 
      font-weight: 600; 
      margin: 0;
    }
    .edit-modal-close { 
      background: none; 
      border: none; 
      font-size: 1.5rem; 
      cursor: pointer; 
      padding: 0; 
      width: 24px; 
      height: 24px;
    }
    .edit-form-group { 
      margin-bottom: 16px;
    }
    .edit-form-label { 
      display: block; 
      margin-bottom: 4px; 
      font-weight: 600; 
      color: #333;
    }
    .edit-form-input { 
      width: 100%; 
      padding: 8px 12px; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      font-size: 1rem;
    }
    .edit-form-input:focus { 
      outline: none; 
      border-color: #007bff; 
      box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    .edit-form-textarea { 
      min-height: 80px; 
      resize: vertical;
    }
    .edit-modal-actions { 
      display: flex; 
      gap: 8px; 
      justify-content: flex-end; 
      margin-top: 20px; 
      padding-top: 16px; 
      border-top: 1px solid #eee;
    }
    .edit-btn-save { 
      background: #28a745; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-weight: 600;
    }
    .edit-btn-save:hover { background: #218838; }
    .edit-btn-save:disabled { background: #6c757d; cursor: not-allowed; }
    .edit-btn-cancel { 
      background: #6c757d; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-weight: 600;
    }
    .edit-btn-cancel:hover { background: #545b62; }
  </style>
</head>
<body>
  <!-- HERO HEADER WITH TOTAL BUDGET (TOP RIGHT) -->
  <header class="hero">
    <div class="hero-inner">
      <h1>Brandeis Open Access Fund</h1>
      <div class="budget-box">
        <span class="budget-label">Total Budget</span>
        <span id="totalBudget" class="budget-amount">—</span>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">
          <span class="budget-label">Running Total</span>
          <span class="budget-amount" style="font-size: 1.4rem;" id="runningTotal">—</span>
        </div>
      </div>
    </div>
  </header>

  <div class="wrapper">
    <!-- Fixed sections that don't scroll -->
    <div class="fixed-sections">
      <section class="card" style="margin-bottom:14px;">
        <header class="section-head">
          <h2>Dashboard</h2>
          <div class="actions">
            <button class="ghost" id="refreshBtn">Refresh</button>
            <button class="ghost" id="historyBtn" type="button">Budget History</button>
            <button class="ghost" id="filesBtn" type="button">Files</button>
          </div>
        </header>
        <div id="status" class="small">Loading…</div>
      </section>
    </div>

    <!-- Scrollable requests section -->
    <div class="scrollable-section">
      <section id="requestsSection" class="card" style="height: 100%; display: flex; flex-direction: column;">
        <header class="section-head" style="flex-shrink: 0;"><h2>Open Access Fund Requests</h2></header>
        
        <!-- Column Toggle Controls -->
        <div class="column-controls" style="flex-shrink: 0;">
          <span style="font-weight: 600; font-size: 0.9rem;">Show Columns:</span>
          <button class="column-toggle active" data-priority="2">Author & Journal</button>
          <button class="column-toggle active" data-priority="3">Details</button>
          <button class="column-toggle active" data-priority="4">Extended Info</button>
          <div class="columns-info">
            <span id="columnsInfo">All columns visible</span>
          </div>
        </div>
        
        <div class="table-wrap" style="flex: 1; overflow: auto;">
          <table id="requestsTable" aria-describedby="status">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="edit-modal">
    <div class="edit-modal-content">
      <div class="edit-modal-header">
        <h3 class="edit-modal-title">Edit Request Field</h3>
        <button class="edit-modal-close" id="editModalClose">&times;</button>
      </div>
      <form id="editForm">
        <div class="edit-form-group">
          <label class="edit-form-label" for="editFieldSelect">Field to Edit:</label>
          <select id="editFieldSelect" class="edit-form-input" required>
            <option value="">Select a field...</option>
            <option value="email">Email Address</option>
            <option value="title">Title of Article/Chapter/Book</option>
            <option value="amount">Amount Requested</option>
            <option value="author">Corresponding Author Name</option>
            <option value="authorORCiD">Corresponding Author ORCiD</option>
            <option value="collab">Collaborating Author List</option>
            <option value="collabORCiD">Collaborating Author ORCiD List</option>
            <option value="journal">Title of Journal</option>
            <option value="journalISSN">Journal ISSN</option>
            <option value="publisher">Publisher</option>
            <option value="status">Article Status</option>
            <option value="type">Publication Type</option>
            <option value="DOI">DOI</option>
            <option value="comment">Comment to Library Team</option>
          </select>
        </div>
        <div class="edit-form-group">
          <label class="edit-form-label" for="editValue">New Value:</label>
          <input type="text" id="editValue" class="edit-form-input" placeholder="Enter new value..." required>
        </div>
        <div class="edit-modal-actions">
          <button type="button" class="edit-btn-cancel" id="editModalCancel">Cancel</button>
          <button type="submit" class="edit-btn-save" id="saveEditBtn">Save Edit</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---- Token cookie helper + fetch wrapper ----
    function getTokenFromCookie() {
      try {
        return document.cookie
          .split(';')
          .map(s => s.trim())
          .filter(Boolean)
          .map(s => s.split('='))
          .reduce((acc, [k,v]) => (acc[decodeURIComponent(k)] = decodeURIComponent(v || ''), acc), {})['token'] || '';
      } catch (_) { return ''; }
    }
    (function wrapFetchForAuth(){
      const origFetch = window.fetch.bind(window);
      window.fetch = (input, init = {}) => {
        const headers = new Headers((init && init.headers) || {});
        if (!headers.has('Authorization')) {
          const t = getTokenFromCookie();
          if (t) headers.set('Authorization', 'Bearer ' + t);
        }
        if (!headers.has('Accept')) headers.set('Accept', 'application/json; charset=utf-8');
        return origFetch(input, { ...init, headers });
      };
    })();

    (function () {
      const fetchUrl = "<%= typeof fetchUrl !== 'undefined' ? fetchUrl : endPoint + '/fetch' %>";
      const fetchBudgetUrl = "<%= typeof fetchBudgetUrl !== 'undefined' ? fetchBudgetUrl : endPoint + '/fetchBudget' %>";
      // const fetchUrl = "<%= typeof fetchUrl !== 'undefined' ? fetchUrl : 'https://oafund.library.brandeis.edu/fetch' %>";
      // const fetchBudgetUrl = "<%= typeof fetchBudgetUrl !== 'undefined' ? fetchBudgetUrl : 'https://oafund.library.brandeis.edu/fetchBudget' %>";

      // Endpoints (no trailing slash). We'll append /:timestamp at runtime.
      const endpoints = {
        APPROVED: "<%= typeof approveUrl !== 'undefined' ? approveUrl.replace(/\/$/, '') : endPoint + '/approve' %>",
        DENIED: "<%= typeof denyUrl !== 'undefined' ? denyUrl.replace(/\/$/, '') : endPoint + '/deny' %>",
        CANCELLED: "<%= typeof cancelUrl !== 'undefined' ? cancelUrl.replace(/\/$/, '') : endPoint + '/cancel' %>",
        PAID: "<%= typeof paidUrl !== 'undefined' ? paidUrl.replace(/\/$/, '') : endPoint + '/paid' %>",
        PAYMENT_PLANNED: "<%= typeof paymentPlannedUrl !== 'undefined' ? paymentPlannedUrl.replace(/\/$/, '') : endPoint + '/planned' %>"
        // APPROVED: "<%= typeof approveUrl !== 'undefined' ? approveUrl.replace(/\/$/, '') : 'https://oafund.library.brandeis.edu/approve' %>",
        // DENIED: "<%= typeof denyUrl !== 'undefined' ? denyUrl.replace(/\/$/, '') : 'https://oafund.library.brandeis.edu/deny' %>",
        // CANCELLED: "<%= typeof cancelUrl !== 'undefined' ? cancelUrl.replace(/\/$/, '') : 'https://oafund.library.brandeis.edu/cancel' %>",
        // PAID: "<%= typeof paidUrl !== 'undefined' ? paidUrl.replace(/\/$/, '') : 'https://oafund.library.brandeis.edu/paid' %>",
        // PAYMENT_PLANNED: "<%= typeof paymentPlannedUrl !== 'undefined' ? paymentPlannedUrl.replace(/\/$/, '') : 'https://oafund.library.brandeis.edu/planned' %>"
      };

      const statusEl = document.getElementById('status');
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      const refreshBtn = document.getElementById('refreshBtn');
      const totalBudgetEl = document.getElementById('totalBudget');
      const runningTotalEl = document.getElementById('runningTotal');
      const historyBtn = document.getElementById('historyBtn');
      const filesBtn = document.getElementById('filesBtn');
      const columnsInfo = document.getElementById('columnsInfo');

      // Navigate to budget history page
      historyBtn.addEventListener('click', () => {
        window.location.href = '/budget-history';
      });

      // Navigate to files page
      filesBtn.addEventListener('click', () => {
        window.location.href = '/files-page';
      });

      // Column toggle functionality
      document.querySelectorAll('.column-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const groupId = btn.getAttribute('data-priority'); // keeping same attribute name for compatibility
          btn.classList.toggle('active');
          
          // Toggle column visibility
          const isVisible = btn.classList.contains('active');
          document.querySelectorAll(`.toggle-group-${groupId}`).forEach(el => {
            el.style.display = isVisible ? '' : 'none';
          });
          
          updateColumnsInfo();
        });
      });

      function updateColumnsInfo() {
        const activeToggles = document.querySelectorAll('.column-toggle.active');
        const totalToggles = document.querySelectorAll('.column-toggle');
        
        if (activeToggles.length === totalToggles.length) {
          columnsInfo.textContent = 'All columns visible';
        } else if (activeToggles.length === 0) {
          columnsInfo.textContent = 'Only essential columns visible';
        } else {
          columnsInfo.textContent = `${activeToggles.length + 1} of ${totalToggles.length + 1} column groups visible`;
        }
      }

      refreshBtn.addEventListener('click', () => { loadData(); loadBudget(); });

      function fmtDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }
      function normalizeUnicode(v) { try { return String(v).normalize('NFC'); } catch { return String(v); } }
      function money(n) { const num = Number(n); if (!isFinite(num)) return String(n); try { return new Intl.NumberFormat(undefined, { style:'currency', currency:'USD', maximumFractionDigits:0 }).format(num); } catch { return String(num); } }

      function renderTable(rows) {
        if (!Array.isArray(rows) || rows.length === 0) {
          thead.innerHTML = '';
          tbody.innerHTML = '<tr><td class="small">No data.</td></tr>';
          return;
        }
        const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
        // Define custom column titles mapping
        const columnTitles = {
          'Timestamp': 'Timestamp',
          'Email Address': 'Email',
          'Title of Article / Chapter / Book': 'Title',
          'Amount requested': 'Amount',
          'Corresponding Author Name': 'Author',
          'Corresponding Author ORCiD': 'Author ORCiD',
          'Title of Journal': 'Journal',
          'Journal ISSN': 'Journal ISSN',
          'Publisher': 'Publisher',
          'Article Status': 'Article Status',
          'Publication Type': 'Publication Type',
          'Collaborating Author List': 'Collabs',
          'Collaborating Author ORCiD List (Optional)': 'Collab ORCiDs',
          'DOI (if applicable)': 'DOI',
          'Comment to library publishing team': 'Comment',
          'OA fund status': 'OA Fund Status'
        };

        // Define column groups for manual toggles
        const columnGroups = {
          // Group 2: Author & Journal info
          'group2': ['Corresponding Author Name', 'Title of Journal', 'Publisher'],
          
          // Group 3: Details
          'group3': ['Article Status', 'Publication Type', 'Journal ISSN'],
          
          // Group 4: Extended info
          'group4': ['Corresponding Author ORCiD', 'Collaborating Author List', 'Collaborating Author ORCiD List (Optional)', 'DOI (if applicable)', 'Comment to library publishing team']
        };
        
        // UPDATE THIS TO REFLECT THE COLUMN ORDER
        const prefer = [
          'Timestamp','Amount requested','OA fund status','Email Address','Title of Article / Chapter / Book',
          'Corresponding Author Name','Corresponding Author ORCiD','Title of Journal','Journal ISSN','Publisher',
          'Article Status','Publication Type','Collaborating Author List','Collaborating Author ORCiD List (Optional)',
          'DOI (if applicable)','Comment to library publishing team'
        ];
        cols.sort((a,b)=>{ const ia = prefer.indexOf(a), ib = prefer.indexOf(b); if (ia === -1 && ib === -1) return a.localeCompare(b); if (ia === -1) return 1; if (ib === -1) return -1; return ia - ib; });
        
        // Generate table header with group classes for manual toggles
        const headerCells = cols.map(c => {
          let groupClass = '';
          let colClass = '';
          
          // Apply toggle group classes
          if (columnGroups.group2.includes(c)) groupClass = 'toggle-group-2';
          else if (columnGroups.group3.includes(c)) groupClass = 'toggle-group-3';
          else if (columnGroups.group4.includes(c)) groupClass = 'toggle-group-4';
          
          // Apply specific column width classes
          if (c === 'Timestamp') colClass = 'col-timestamp';
          else if (c === 'Email Address') colClass = 'col-email';
          else if (c === 'Title of Article / Chapter / Book') colClass = 'col-title';
          else if (c === 'Amount requested') colClass = 'col-amount';
          else if (c === 'Corresponding Author Name') colClass = 'col-author';
          else if (c === 'Corresponding Author ORCiD') colClass = 'col-orcid';
          else if (c === 'Title of Journal') colClass = 'col-journal';
          else if (c === 'Journal ISSN') colClass = 'col-issn';
          else if (c === 'Publisher') colClass = 'col-publisher';
          else if (c === 'Article Status') colClass = 'col-article-status';
          else if (c === 'Publication Type') colClass = 'col-pub-type';
          else if (c === 'Collaborating Author List') colClass = 'col-collabs';
          else if (c === 'Collaborating Author ORCiD List (Optional)') colClass = 'col-collab-orcid';
          else if (c === 'DOI (if applicable)') colClass = 'col-doi';
          else if (c === 'Comment to library publishing team') colClass = 'col-comment';
          else if (c === 'OA fund status') colClass = 'col-status';
          
          const displayTitle = columnTitles[c] || c;
          return `<th class="${(groupClass + ' ' + colClass).trim()}">${displayTitle}</th>`;
        }).join('');
        thead.innerHTML = `<tr><th class="nowrap">Actions</th>` + headerCells + `</tr>`;
        

        const frag = document.createDocumentFragment();
        rows.forEach((row) => {
          const tr = document.createElement('tr');
          
          // Process columns in the preferred order
          cols.forEach((col, index) => {
            const td = document.createElement('td');
            
            let val = row[col];
            if (col === 'Timestamp' && val) val = fmtDate(val);
            
            // highlight row based on status
            if (col === 'OA fund status') {
              const v = String(val || '').trim().toUpperCase();
              if (v === 'PAID') tr.classList.add('paid-bg');
              else if (v === 'DENIED') tr.classList.add('denied-bg');
              else if (v === 'CANCELLED') tr.classList.add('cancelled-bg');
              td.classList.add('nowrap');
            }
            
            // Apply group classes for manual toggles and specific column classes
            let groupClass = '';
            let colClass = '';
            
            if (columnGroups.group2.includes(col)) groupClass = 'toggle-group-2';
            else if (columnGroups.group3.includes(col)) groupClass = 'toggle-group-3';
            else if (columnGroups.group4.includes(col)) groupClass = 'toggle-group-4';
            
            // Apply specific column width classes
            if (col === 'Timestamp') colClass = 'col-timestamp';
            else if (col === 'Email Address') colClass = 'col-email';
            else if (col === 'Title of Article / Chapter / Book') colClass = 'col-title';
            else if (col === 'Amount requested') colClass = 'col-amount';
            else if (col === 'Corresponding Author Name') colClass = 'col-author';
            else if (col === 'Corresponding Author ORCiD') colClass = 'col-orcid';
            else if (col === 'Title of Journal') colClass = 'col-journal';
            else if (col === 'Journal ISSN') colClass = 'col-issn';
            else if (col === 'Publisher') colClass = 'col-publisher';
            else if (col === 'Article Status') colClass = 'col-article-status';
            else if (col === 'Publication Type') colClass = 'col-pub-type';
            else if (col === 'Collaborating Author List') colClass = 'col-collabs';
            else if (col === 'Collaborating Author ORCiD List (Optional)') colClass = 'col-collab-orcid';
            else if (col === 'DOI (if applicable)') colClass = 'col-doi';
            else if (col === 'Comment to library publishing team') colClass = 'col-comment';
            else if (col === 'OA fund status') colClass = 'col-status';
            
            td.className = (groupClass + ' ' + colClass).trim();
            
            td.textContent = (val == null ? '' : String(val));
            tr.appendChild(td);
            
            // Insert Actions column after Timestamp (index 0)
            if (index === 0) {
              const tdAct = document.createElement('td');
              tdAct.className = 'actions-cell';
              tdAct.append(makeActionSelect(row));
              tr.appendChild(tdAct);
            }
          });

          frag.appendChild(tr);
        });
        tbody.innerHTML = '';
        tbody.appendChild(frag);
      }

      function allowedActionsFor(row) {
        const raw = row['OA fund status'] ?? row['oa fund status'] ?? row['status'] ?? '';
        const s = String(raw).trim().toUpperCase();
        // Map submitted-ish statuses
        const isSubmitted = s === 'SUBMITTED' || s === '' || s === 'SUBMIT' || s === 'PENDING';
        if (isSubmitted) return [
          { label: 'Approve', key: 'APPROVED' },
          { label: 'Deny',    key: 'DENIED' }
        ];
        if (s === 'APPROVED') return [
          { label: 'Cancel',          key: 'CANCELLED' },
          { label: 'Paid',            key: 'PAID' },
          { label: 'Payment Planned', key: 'PAYMENT_PLANNED' }
        ];
        if (s === 'PAYMENT_PLANNED' || s === 'TRANSACTION_PLANNED' || s === 'PLANNED') return [
          { label: 'Paid', key: 'PAID' }
        ];
        // DENIED / PAID -> no actions
        return [];
      }

      function makeActionSelect(row) {
        const wrap = document.createElement('div');
        wrap.className = 'inline-controls';
        const sel = document.createElement('select');
        sel.className = 'action-select';

        const opts = allowedActionsFor(row);
        if (!opts.length) {
          sel.disabled = true;
          const opt = new Option('No actions', '', true, true);
          sel.add(opt);
        } else {
          sel.add(new Option('Choose…', '', true, true));
          for (const o of opts) sel.add(new Option(o.label, o.key));
          sel.addEventListener('change', async () => {
            const key = sel.value;
            if (!key) return;
            // hit endpoint
            await hitActionEndpoint(endpoints[key], row, sel);
            sel.value = ''; // reset
          });
        }
        wrap.appendChild(sel);
        
        // Add edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.textContent = 'Edit Value';
        editBtn.addEventListener('click', () => {
          openEditModal(row);
        });
        wrap.appendChild(editBtn);
        
        return wrap;
      }

      function encodeSegAllowColon(s) { const str = normalizeUnicode(s); return encodeURIComponent(str).replace(/%3A/gi, ':'); }
      function joinPath(base, ...segments) { const b = base.replace(/\/$/, ''); const tail = segments.map(encodeSegAllowColon).join('/'); return tail ? b + '/' + tail : b; }

      async function hitActionEndpoint(endpoint, row, controlEl, extraPathSegments = []) {
        try {
          controlEl.disabled = true;
          const ts = row['Timestamp'];
          if (!ts) { alert('No Timestamp found for this row.'); return; }
          const url = joinPath(endpoint, ts, ...extraPathSegments);
          const res = await fetch(url, { method: 'PUT', headers: { 'Accept': 'application/json; charset=utf-8' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          statusEl.textContent = `Action sent to ${url}`;
        } catch (err) {
          alert('Action failed: ' + err.message);
        } finally {
          controlEl.disabled = false;
          loadData();
          loadBudget(); // refresh total on every action
        }
      }

      async function loadData() {
        statusEl.textContent = 'Loading…';
        try {
          const res = await fetch(fetchUrl, { method: 'GET', headers: { 'Accept': 'application/json; charset=utf-8' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          let data = await res.json();
          data = data.reverse()
          renderTable(Array.isArray(data) ? data : []);
          statusEl.textContent = `Loaded ${Array.isArray(data) ? data.length : 0} record(s).`;
        } catch (err) {
          statusEl.textContent = 'Failed to load: ' + err.message;
          thead.innerHTML = '';
          tbody.innerHTML = '';
        }
      }

      async function loadBudget() {
        try {
          const res = await fetch(fetchBudgetUrl, { method: 'GET', headers: { 'Accept': 'application/json; charset=utf-8' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          let arr = Array.isArray(data) ? data : [];
          if (arr.length) {
            const last = arr[arr.length - 1];
            const total = last && (Number(last['Total Amount']) || Number(last.total) || Number(last.amount));
            const runningTotal = last && (Number(last['RunningTotal']) || Number(last.runningTotal) || 0);
            totalBudgetEl.textContent = (total != null && isFinite(total)) ? money(total) : 'N/A';
            runningTotalEl.textContent = (runningTotal != null && isFinite(runningTotal)) ? money(runningTotal) : 'N/A';
          } else { 
            totalBudgetEl.textContent = 'N/A'; 
            runningTotalEl.textContent = 'N/A';
          }
        } catch (e) { 
          totalBudgetEl.textContent = 'N/A'; 
          runningTotalEl.textContent = 'N/A';
        }
      }

      // Edit modal functionality
      let currentEditRow = null;
      
      function openEditModal(row) {
        currentEditRow = row;
        const modal = document.getElementById('editModal');
        modal.classList.add('show');
        
        // Reset form
        document.getElementById('editFieldSelect').value = '';
        document.getElementById('editValue').value = '';
        
        // Focus on field select
        document.getElementById('editFieldSelect').focus();
      }
      
      function closeEditModal() {
        console.log('closeEditModal called');
        const modal = document.getElementById('editModal');
        modal.classList.remove('show');
        currentEditRow = null;
      }
      
      // Handle form submission
      document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentEditRow) return;
        
        const field = document.getElementById('editFieldSelect').value;
        const value = document.getElementById('editValue').value;
        
        if (!field || !value) {
          alert('Please select a field and enter a value.');
          return;
        }
        
        const saveBtn = document.getElementById('saveEditBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
          await saveEdit(currentEditRow, field, value);
          closeEditModal();
          // Refresh data to show changes
          loadData();
          statusEl.textContent = `Field "${field}" updated successfully.`;
        } catch (error) {
          alert('Failed to save edit: ' + error.message);
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Edit';
        }
      });
      
      // Handle modal close on background click
      document.getElementById('editModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          closeEditModal();
        }
      });
      
      // Handle escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('show')) {
          closeEditModal();
        }
      });
      
      // Setup modal event listeners after DOM is ready
      function setupModalEventListeners() {
        const closeBtn = document.getElementById('editModalClose');
        const cancelBtn = document.getElementById('editModalCancel');
        
        if (closeBtn) {
          closeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Close button clicked');
            closeEditModal();
          });
        }
        
        if (cancelBtn) {
          cancelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('Cancel button clicked');
            closeEditModal();
          });
        }
      }
      
      async function saveEdit(row, field, value) {
        const timestamp = row['Timestamp'];
        if (!timestamp) {
          throw new Error('No timestamp found for this row.');
        }
        
        const updateUrl = "<%= typeof endPoint !== 'undefined' ? endPoint + '/update' : 'http://localhost:3000/update' %>";
        const url = `${updateUrl}/${encodeURIComponent(timestamp)}?${field}=${encodeURIComponent(value)}`;
        
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Accept': 'application/json; charset=utf-8'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response;
      }

      // initial
      loadData();
      loadBudget();
      
      // Setup modal event listeners
      setupModalEventListeners();
    })();
  </script>
</body>
</html>