<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= typeof pageTitle !== 'undefined' ? pageTitle : 'OA Requests' %></title>
  <style>
    :root { --radius: 16px; --gap: 12px; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: #fff;
      color: #111;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.45;
    }

    /* --- HERO HEADER --- */
    .hero {
      height: 180px;
      background: url('<%= typeof headerBgUrl !== 'undefined' ? headerBgUrl : '/public/header.jpg' %>') center/cover no-repeat;
      position: relative;
      display: flex; align-items: center; justify-content: center;
    }
    .hero::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,.28); }
    .hero-inner {
      position: relative; z-index: 1; width: min(1200px, 100%);
      display: flex; align-items: center; justify-content: space-between;
      gap: 16px; padding: 0 20px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,.45);
    }
    .hero h1 { margin: 0; font-size: 1.5rem; }
    .budget-box { text-align: right; }
    .budget-label { display:block; font-size: .9rem; opacity:.9; }
    .budget-amount { font-size: 1.9rem; font-weight: 800; letter-spacing:.3px; }

    /* --- LAYOUT --- */
    .wrapper { min-height: calc(100vh - 180px); display: grid; padding: 24px; }
    .card { background: #fff; border: 1px solid #eee; border-radius: var(--radius); box-shadow: 0 1px 6px rgba(0,0,0,.06); padding: 20px; }

    header.section-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    h2 { margin: 0; font-size: 1.2rem; }
    .actions { display:flex; align-items:center; gap:8px; }
    button, .btn { display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; border:1px solid #ddd; background:#111; color:#fff; border-radius:999px; font-weight:700; cursor:pointer; }
    button.ghost { background:#fff; color:#111; }

    /* dropdown button */
    details.drop { position: relative; }
    details.drop > summary { list-style:none; cursor:pointer; }
    details.drop[open] > summary { opacity:.9; }
    details.drop .menu { position:absolute; right:0; top:calc(100% + 6px); background:#fff; border:1px solid #eee; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.08); padding:6px; min-width: 180px; z-index: 10; }
    .menu .menu-item { width:100%; text-align:left; background:#fff; color:#111; border:0; border-radius:8px; padding:8px 10px; }
    .menu .menu-item:hover { background:#f7f7f7; }

    .status { font-weight:700; padding:4px 8px; border-radius:999px; border:1px solid #eee; }
    .table-wrap { overflow:auto; border:1px solid #eee; border-radius:12px; }
    table { width:100%; border-collapse:separate; border-spacing:0; min-width:900px; }
    thead th { position:sticky; top:0; background:#fafafa; border-bottom:1px solid #eee; text-align:left; padding:10px; font-size:.9rem; }
    tbody td { border-bottom:1px solid #f1f1f1; padding:10px; vertical-align:top; font-size:.95rem; }
    tbody tr:hover { background:#fcfcfc; }
    .nowrap { white-space:nowrap; }
    .small { font-size:.85rem; color:#444; }
    .actions-cell { min-width: 540px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- HERO HEADER WITH TOTAL BUDGET (TOP RIGHT) -->
  <header class="hero">
    <div class="hero-inner">
      <h1>Open Access Fund</h1>
      <div class="budget-box">
        <span class="budget-label">Total Budget</span>
        <span id="totalBudget" class="budget-amount">—</span>
      </div>
    </div>
  </header>

  <div class="wrapper">
    <!-- CONTROLS -->
    <section class="card" style="margin-bottom:14px;">
      <header class="section-head">
        <h2>Dashboard</h2>
        <div class="actions">
          <button class="ghost" id="refreshBtn">Refresh</button>
          <!-- <details class="drop">
            <summary class="btn ghost">View ▾</summary>
            <div class="menu">
              <button type="button" class="menu-item" data-view="requests">Requests</button>
              <button type="button" class="menu-item" data-view="history">Budget history</button>
            </div>
          </details> -->
          <button type="button" class="menu-item" data-view="requests">Requests</button>
          <button type="button" class="menu-item" data-view="history">Budget history</button>
          <!-- <button class="ghost" id="historyBtn" type="button">Budget History</button> -->
        </div>
      </header>
      <div id="status" class="small">Loading…</div>
    </section>

    <!-- REQUESTS VIEW -->
    <section id="requestsSection" class="card">
      <header class="section-head">
        <h2>Open Access Fund Requests</h2>
      </header>
      <div class="table-wrap">
        <table id="requestsTable" aria-describedby="status">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- BUDGET HISTORY VIEW -->
    <section id="historySection" class="card hidden">
      <header class="section-head">
        <h2>Budget History</h2>
      </header>
      <div class="table-wrap">
        <table aria-describedby="status">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Total Amount</th>
              <th>Change</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ---- Token cookie helper + fetch wrapper ----
    function getTokenFromCookie() {
      try {
        return document.cookie
          .split(';')
          .map(s => s.trim())
          .filter(Boolean)
          .map(s => s.split('='))
          .reduce((acc, [k,v]) => (acc[decodeURIComponent(k)] = decodeURIComponent(v || ''), acc), {})['token'] || '';
      } catch (_) { return ''; }
    }
    (function wrapFetchForAuth(){
      const origFetch = window.fetch.bind(window);
      window.fetch = (input, init = {}) => {
        const headers = new Headers((init && init.headers) || {});
        if (!headers.has('Authorization')) {
          const t = getTokenFromCookie();
          if (t) headers.set('Authorization', 'Bearer ' + t);
        }
        if (!headers.has('Accept')) headers.set('Accept', 'application/json; charset=utf-8');
        return origFetch(input, { ...init, headers });
      };
    })();

    (function () {
      const fetchUrl = "<%= typeof fetchUrl !== 'undefined' ? fetchUrl : 'http://localhost:3000/fetch' %>";
      const fetchBudgetUrl = "<%= typeof fetchBudgetUrl !== 'undefined' ? fetchBudgetUrl : 'http://localhost:3000/fetchBudget' %>";

      // Base endpoints per action (no trailing slash). We'll append /:timestamp at runtime.
      const endpoints = {
        APPROVED: "<%= typeof approveUrl !== 'undefined' ? approveUrl.replace(/\/$/, '') : 'http://localhost:3000/approve' %>",
        DENIED: "<%= typeof denyUrl !== 'undefined' ? denyUrl.replace(/\/$/, '') : 'http://localhost:3000/deny' %>",
        CANCELLED: "<%= typeof cancelUrl !== 'undefined' ? cancelUrl.replace(/\/$/, '') : 'http://localhost:3000/cancel' %>",
        PAID: "<%= typeof paidUrl !== 'undefined' ? paidUrl.replace(/\/$/, '') : 'http://localhost:3000/paid' %>",
        PAYMENT_PLANNED: "<%= typeof paymentPlannedUrl !== 'undefined' ? paymentPlannedUrl.replace(/\/$/, '') : 'http://localhost:3000/planned' %>"
      };

      const statusEl = document.getElementById('status');
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      const refreshBtn = document.getElementById('refreshBtn');
      const totalBudgetEl = document.getElementById('totalBudget');

      const requestsSection = document.getElementById('requestsSection');
      const historySection = document.getElementById('historySection');
      const historyBody = document.getElementById('historyBody');

      // View toggles
      document.querySelectorAll('.menu-item').forEach(btn => btn.addEventListener('click', () => setView(btn.dataset.view)));
      // document.getElementById('historyBtn').addEventListener('click', () => setView('history'));
      function setView(which) {
        const showHistory = which === 'history';
        requestsSection.classList.toggle('hidden', showHistory);
        historySection.classList.toggle('hidden', !showHistory);
        // close dropdown if open
        const dd = document.querySelector('details.drop');
        if (dd && dd.open) dd.open = false;
      }

      refreshBtn.addEventListener('click', () => {
        loadData();
        loadBudget();
      });

      function fmtDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }
      function normalizeUnicode(v) { try { return String(v).normalize('NFC'); } catch { return String(v); } }
      function money(n) {
        const num = Number(n);
        if (!isFinite(num)) return String(n);
        try { return new Intl.NumberFormat(undefined, { style:'currency', currency:'USD', maximumFractionDigits:0 }).format(num); }
        catch { return String(num); }
      }

      function renderTable(rows) {
        if (!Array.isArray(rows) || rows.length === 0) {
          thead.innerHTML = '';
          tbody.innerHTML = '<tr><td class="small">No data.</td></tr>';
          return;
        }
        const cols = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
        const prefer = [
          'Timestamp','Email Address','Title of Article / Chapter / Book','Amount requested from open access fund',
          'Corresponding Author Name','Corresponding Author ORCiD','Collaborating Author List','Collaborating Author ORCiD List (Optional)',
          'Title of Journal','Journal ISSN','Publisher','Article Status','Publication Type','DOI (if applicable)','Comment to library publishing team','OA fund status'
        ];
        cols.sort((a,b)=>{ const ia = prefer.indexOf(a), ib = prefer.indexOf(b); if (ia === -1 && ib === -1) return a.localeCompare(b); if (ia === -1) return 1; if (ib === -1) return -1; return ia - ib; });
        thead.innerHTML = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '<th class="nowrap">Actions</th>' + '</tr>';
        const frag = document.createDocumentFragment();
        rows.forEach((row) => {
          const tr = document.createElement('tr');
          cols.forEach(col => {
            const td = document.createElement('td');
            let val = row[col];
            if (col === 'Timestamp' && val) val = fmtDate(val);
            td.textContent = (val == null ? '' : String(val));
            if (col === 'OA fund status') td.classList.add('nowrap');
            tr.appendChild(td);
          });
          const tdAct = document.createElement('td');
          tdAct.className = 'actions-cell';
          tdAct.append(
            makeActionBtn('Approve', endpoints.APPROVED, row), ' ',
            makeActionBtn('Deny', endpoints.DENIED, row), ' ',
            makeActionBtn('Cancelled', endpoints.CANCELLED, row), ' ',
            makeActionBtn('Paid', endpoints.PAID, row), ' ',
            makeActionBtn('Payment Planned', endpoints.PAYMENT_PLANNED, row)
          );
          tr.appendChild(tdAct);
          frag.appendChild(tr);
        });
        tbody.innerHTML = '';
        tbody.appendChild(frag);
      }

      function makeActionBtn(label, endpoint, row) {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = label;
        btn.addEventListener('click', async () => { await hitActionEndpoint(endpoint, row, btn); });
        return btn;
      }

      function encodeSegAllowColon(s) { const str = normalizeUnicode(s); return encodeURIComponent(str).replace(/%3A/gi, ':'); }
      function joinPath(base, ...segments) { const b = base.replace(/\/$/, ''); const tail = segments.map(encodeSegAllowColon).join('/'); return tail ? b + '/' + tail : b; }

      async function hitActionEndpoint(endpoint, row, btnEl, extraPathSegments = []) {
        try {
          btnEl.disabled = true;
          const ts = row['Timestamp'];
          if (!ts) { alert('No Timestamp found for this row.'); return; }
          const url = joinPath(endpoint, ts, ...extraPathSegments);
          const res = await fetch(url, { method: 'PUT', headers: { 'Accept': 'application/json; charset=utf-8' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          statusEl.textContent = `Action sent to ${url}`;
        } catch (err) {
          alert('Action failed: ' + err.message);
        } finally { btnEl.disabled = false; loadData(); loadBudget();}
      }

      async function loadData() {
        statusEl.textContent = 'Loading…';
        try {
          const res = await fetch(fetchUrl, { method: 'GET', headers: { 'Accept': 'application/json; charset=utf-8' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          renderTable(Array.isArray(data) ? data : []);
          statusEl.textContent = `Loaded ${Array.isArray(data) ? data.length : 0} record(s).`;
        } catch (err) {
          statusEl.textContent = 'Failed to load: ' + err.message;
          thead.innerHTML = '';
          tbody.innerHTML = '';
        }
      }

      async function loadBudget() {
        try {
          const res = await fetch(fetchBudgetUrl, { method: 'GET', headers: { 'Accept': 'application/json; charset=utf-8' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          const arr = Array.isArray(data) ? data : [];
          if (arr.length) {
            // last entry's Total Amount is the total budget
            const last = arr[arr.length - 1];
            const total = last && (Number(last['Total Amount']) || Number(last.total) || Number(last.amount));
            totalBudgetEl.textContent = (total != null && isFinite(total)) ? money(total) : 'N/A';
            renderHistory(arr);
          } else {
            totalBudgetEl.textContent = 'N/A';
            renderHistory([]);
          }
        } catch (e) {
          totalBudgetEl.textContent = 'N/A';
          renderHistory([]);
        }
      }

      function renderHistory(rows) {
        historyBody.innerHTML = '';
        if (!rows || !rows.length) { historyBody.innerHTML = '<tr><td colspan="4" class="small">No history.</td></tr>'; return; }
        const frag = document.createDocumentFragment();
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td'); td1.textContent = fmtDate(r['Timestamp'] || r.timestamp || '');
          const td2 = document.createElement('td'); td2.textContent = money(r['Total Amount'] ?? r.total ?? r.amount ?? '');
          const td3 = document.createElement('td'); td3.textContent = money(r['Change'] ?? r.change ?? 0);
          const td4 = document.createElement('td'); td4.textContent = (r['Reason'] ?? r.reason ?? '') + '';
          tr.append(td1, td2, td3, td4);
          frag.appendChild(tr);
        });
        historyBody.appendChild(frag);
      }

      // initial
      loadData();
      loadBudget();
    })();
  </script>
</body>
</html>
