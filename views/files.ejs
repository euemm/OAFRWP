<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= typeof pageTitle !== 'undefined' ? pageTitle : 'Uploaded Files & URLs' %></title>
  <link rel="icon" type="image/png" href="/public/brandeis.png">
  <link rel="shortcut icon" type="image/png" href="/public/brandeis.png">
  <style>
    :root { --radius: 16px; --gap: 12px; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: #fff; color: #111; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; line-height: 1.45; }

    /* --- HERO HEADER --- */
    .hero { height: 180px; background: rgb(18,51,116) center/cover no-repeat; position: relative; display: flex; align-items: center; justify-content: center; }
    .hero::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,.28); }
    .hero-inner { position: relative; z-index: 1; width: min(1200px, 100%); display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 0 20px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,.45); }
    .hero h1 { margin: 0; font-size: 1.5rem; }
    .file-count { text-align: right; }
    .file-count-label { display:block; font-size: .9rem; opacity:.9; }
    .file-count-number { font-size: 1.9rem; font-weight: 800; letter-spacing:.3px; }

    /* --- LAYOUT --- */
    .wrapper { min-height: calc(100vh - 180px); padding: 24px; }
    .card { background: #fff; border: 1px solid #eee; border-radius: var(--radius); box-shadow: 0 1px 6px rgba(0,0,0,.06); padding: 20px; }

    header.section-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    h2 { margin: 0; font-size: 1.2rem; }
    .actions { display:flex; align-items:center; gap:8px; }
    button, .btn { display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; border:1px solid #ddd; background:#111; color:#fff; border-radius:999px; font-weight:700; cursor:pointer; text-decoration: none; }
    button.ghost, .btn.ghost { background:#fff; color:#111; }

    .table-wrap { overflow:auto; border:1px solid #eee; border-radius:12px; }
    table { width:100%; border-collapse:separate; border-spacing:0; min-width:700px; }
    thead th { position:sticky; top:0; background:#fafafa; border-bottom:1px solid #eee; text-align:left; padding:8px 10px; font-size:.9rem; }
    tbody td { border-bottom:1px solid #f1f1f1; padding:8px 10px; vertical-align:top; font-size:.95rem; }
    tbody tr:hover { background:#fcfcfc; }
    .nowrap { white-space:nowrap; }
    .small { font-size:.85rem; color:#444; }
    
    /* Table column alignment */
    .file-name { width: 35%; max-width: 300px; word-break: break-word; }
    .file-type { width: 10%; text-align: center; white-space: nowrap; }
    .file-size { width: 15%; text-align: right; white-space: nowrap; }
    .file-date { width: 25%; text-align: left; white-space: nowrap; }
    .file-actions { width: 15%; text-align: center; min-width: 100px; }

    /* Responsive */
    @media (max-width: 768px) {
      .hero-inner { flex-direction: column; text-align: center; }
      .file-count { text-align: center; margin-top: 10px; }
      table { min-width: 700px; }
      .file-name { width: 30%; max-width: 200px; }
      .file-type { width: 10%; }
      .file-size { width: 15%; }
      .file-date { width: 30%; }
      .file-actions { width: 15%; }
    }
  </style>
</head>
<body>
  <div class="hero">
    <div class="hero-inner">
      <h1><%= typeof pageTitle !== 'undefined' ? pageTitle : 'Files & URLs' %></h1>
      <div class="file-count">
        <span class="file-count-label">Total Items</span>
        <div class="file-count-number" id="itemCount">-</div>
      </div>
    </div>
  </div>

  <div class="wrapper">
    <section class="card" style="margin-bottom:14px;">
      <header class="section-head">
        <h2>Dashboard</h2>
        <div class="actions">
          <button class="ghost" id="refreshBtn">Refresh</button>
          <button class="ghost" id="requestsBtn" type="button">Back to Requests</button>
          <button class="ghost" id="historyBtn" type="button">Budget History</button>
        </div>
      </header>
      <div id="status" class="small">Loadingâ€¦</div>
    </section>

    <!-- FILES VIEW -->
    <section id="filesSection" class="card">
      <header class="section-head">
        <h2>Uploaded Files & URLs</h2>
      </header>

      <div id="loadingState" class="loading" style="padding: 20px; text-align: center; color: #666;">
        Loading files and URLs...
      </div>

      <div id="emptyState" class="empty-state" style="display: none; text-align: center; padding: 30px 20px; color: #666;">
        <h3 style="margin: 0 0 8px; color: #999;">No files or URLs found</h3>
        <p style="margin: 0 0 15px;">No files or URLs have been uploaded yet.</p>
        <a href="/upload" class="btn">Upload Files or URLs</a>
      </div>

      <div id="filesTable" style="display: none;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="file-name">Name/URL</th>
                <th class="file-type">Type</th>
                <th class="file-size">Size</th>
                <th class="file-date">Upload Date</th>
                <th class="file-actions">Actions</th>
              </tr>
            </thead>
            <tbody id="filesTableBody">
              <!-- Files will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Format file size in human readable format
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Format date in human readable format
    function formatDate(isoString) {
      const date = new Date(isoString);
      return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Extract email from filename
    function extractEmailFromFilename(filename) {
      const match = filename.match(/^([^_]+)__/);
      return match ? match[1] : 'Unknown';
    }

    // Extract original filename from the generated filename
    function extractOriginalName(filename) {
      const parts = filename.split('__');
      if (parts.length > 1) {
        const nameWithTimestamp = parts[1];
        // Remove the timestamp part (format: -YYYY-MM-DDTHH-MM-SS-SSSZ.pdf)
        const withoutTimestamp = nameWithTimestamp.replace(/-\d{4}-\d{2}-\d{2}T\d{2}-\d{2}-\d{2}-\d{3}Z\.pdf$/, '.pdf');
        return withoutTimestamp;
      }
      return filename;
    }

    // Load and display files and URLs
    async function loadFiles() {
      try {
        document.getElementById('status').textContent = 'Loading files and URLs...';
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('filesTable').style.display = 'none';

        // Fetch both files and URLs in parallel
        const [filesResponse, urlsResponse] = await Promise.all([
          fetch('<%= fetchFilesUrl %>'),
          fetch('http://localhost:3000/urls')
        ]);

        if (!filesResponse.ok) {
          throw new Error(`Files API error: HTTP ${filesResponse.status}: ${filesResponse.statusText}`);
        }
        if (!urlsResponse.ok) {
          throw new Error(`URLs API error: HTTP ${urlsResponse.status}: ${urlsResponse.statusText}`);
        }

        const filesData = await filesResponse.json();
        const urlsData = await urlsResponse.json();
        
        const files = filesData.files || [];
        const urls = urlsData.urls || [];
        
        // Combine files and URLs into a single array
        const allItems = [
          ...files.map(file => ({
            ...file,
            type: 'file',
            displayName: extractOriginalName(file.name),
            email: extractEmailFromFilename(file.name)
          })),
          ...urls.map(url => ({
            ...url,
            type: 'url',
            displayName: url.url,
            email: url.email || 'Unknown',
            size: null,
            url: url.url
          }))
        ];

        // Sort by date (newest first)
        allItems.sort((a, b) => new Date(b.mtime || b.timestamp || 0) - new Date(a.mtime || a.timestamp || 0));

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('itemCount').textContent = allItems.length;
        document.getElementById('status').textContent = `Found ${allItems.length} item${allItems.length !== 1 ? 's' : ''} (${files.length} files, ${urls.length} URLs)`;

        if (allItems.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
          document.getElementById('status').textContent = 'No files or URLs found';
          return;
        }

        // Populate the table
        const tbody = document.getElementById('filesTableBody');
        tbody.innerHTML = '';

        allItems.forEach(item => {
          const row = document.createElement('tr');
          
          if (item.type === 'file') {
            row.innerHTML = `
              <td class="file-name">
                <div><strong>${item.displayName}</strong></div>
                <div class="small">From: ${item.email}</div>
              </td>
              <td class="file-type">
                <span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">FILE</span>
              </td>
              <td class="file-size">${formatFileSize(item.size)}</td>
              <td class="file-date">${formatDate(item.mtime)}</td>
              <td class="file-actions">
                <a href="${item.url}" target="_blank" class="btn" style="font-size: 0.8rem; padding: 4px 8px;">View</a>
              </td>
            `;
          } else {
            row.innerHTML = `
              <td class="file-name">
                <div><strong>${item.displayName}</strong></div>
                <div class="small">From: ${item.email}</div>
              </td>
              <td class="file-type">
                <span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">URL</span>
              </td>
              <td class="file-size">-</td>
              <td class="file-date">${formatDate(item.timestamp || item.mtime)}</td>
              <td class="file-actions">
                <a href="${item.url}" target="_blank" class="btn" style="font-size: 0.8rem; padding: 4px 8px;">Visit</a>
              </td>
            `;
          }
          tbody.appendChild(row);
        });

        document.getElementById('filesTable').style.display = 'block';

      } catch (error) {
        console.error('Error loading files and URLs:', error);
        document.getElementById('loadingState').innerHTML = `
          <div style="color: #d32f2f;">
            <strong>Error loading files and URLs</strong><br>
            <span class="small">${error.message}</span>
          </div>
        `;
        document.getElementById('status').innerHTML = `<span style="color: #d32f2f;">Error: ${error.message}</span>`;
      }
    }

    // Navigation and event handlers
    document.addEventListener('DOMContentLoaded', () => {
      const refreshBtn = document.getElementById('refreshBtn');
      const requestsBtn = document.getElementById('requestsBtn');
      const historyBtn = document.getElementById('historyBtn');

      // Navigate to requests page
      requestsBtn.addEventListener('click', () => {
        window.location.href = '/requests';
      });

      // Navigate to budget history page
      historyBtn.addEventListener('click', () => {
        window.location.href = '/budget-history';
      });

      // Refresh files and URLs
      refreshBtn.addEventListener('click', () => {
        loadFiles();
      });

      // Load files and URLs on page load
      loadFiles();
    });
  </script>
</body>
</html>
